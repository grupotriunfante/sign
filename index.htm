<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assinatura de Documento</title>
    <style>
        /* SEU CSS CONTINUA IGUAL, SEM MUDANÇAS */
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); width: 100%; max-width: 600px; }
        h2 { text-align: center; color: #333; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .signature-pad-container { border: 1px solid #ddd; border-radius: 4px; position: relative; height: 200px; }
        canvas { width: 100%; height: 100%; display: block; }
        .buttons-container { display: flex; justify-content: space-between; margin-top: 20px; }
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #clear-signature { background-color: #6c757d; }
        #clear-signature:hover { background-color: #5a6268; }
        .summary { display: none; margin-top: 30px; }
        .summary h3 { text-align: center; }
        .summary p { font-size: 16px; margin: 10px 0; }
        .summary img { display: block; margin: 20px auto; border: 1px solid #ddd; border-radius: 4px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
</head>
<body>

<div class="container">
    <div id="form-container">
        <h2>Assinatura de Documento</h2>
        <div class="form-group">
            <p>Por favor, leia o documento no link a seguir antes de assinar: <a href="https://drivetriunfante.com.br/index.php?r=file%2Ffile%2Fdownload&guid=4c3ab701-7733-47c7-842e-80137a7aee62&hash_sha1=a68d19e0" target="_blank">Politica de Compliance. Versão 1</a></p>
        </div>
        <div class="form-group">
            <label for="fullName">Nome Completo:</label>
            <input type="text" id="fullName" name="fullName" required>
        </div>
        <div class="form-group">
            <label for="cpf">CPF:</label>
            <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" required>
        </div>
        <div class="form-group">
            <label for="unidade">Unidade:</label>
            <select id="unidade" name="unidade" required>
                <option value="">Selecione a Unidade</option>
                <option value="TPA">TPA</option><option value="TBA">TBA</option><option value="TCV">TCV</option><option value="ABC">ABC</option><option value="API">API</option><option value="TBL">TBL</option><option value="TSJ">TSJ</option><option value="TPH">TPH</option><option value="MCD">MCD</option><option value="TCG">TCG</option>
            </select>
        </div>
        <div class="form-group">
            <label for="birthDate">Data de Nascimento:</label>
            <input type="text" id="birthDate" name="birthDate" placeholder="DD/MM/AAAA" required>
        </div>
        <div class="form-group">
            <label for="signature">Campo para assinatura (livre):</label>
            <div class="signature-pad-container">
                <canvas id="signature-pad"></canvas>
            </div>
        </div>
        <div class="buttons-container">
            <button id="clear-signature">Limpar Assinatura</button>
            <button id="submit-signature">Assinar e Enviar</button>
        </div>
    </div>
    
    <div id="summary-container" class="summary">
        <h3>✅ Assinatura Enviada com Sucesso!</h3>
        <p><strong>Nome Completo:</strong> <span id="summary-fullName"></span></p>
        <p><strong>CPF:</strong> <span id="summary-cpf"></span></p>
        <p><strong>Unidade:</strong> <span id="summary-unidade"></span></p>
        <p><strong>Data de Nascimento:</strong> <span id="summary-birthDate"></span></p>
        <p><strong>Assinatura Registrada:</strong></p>
        <img id="summary-signature" src="" alt="Assinatura Digital">
        <p style="text-align: center; margin-top: 20px;"><em>Seu registro foi salvo. Você já pode fechar esta janela.</em></p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ****** NENHUMA MUDANÇA NESTA PARTE INICIAL ******
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas);
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();
        const clearButton = document.getElementById('clear-signature');
        clearButton.addEventListener('click', (event) => {
            event.preventDefault();
            signaturePad.clear();
        });

        // ****** A MÁGICA ACONTECE AQUI ******
        const submitButton = document.getElementById('submit-signature');
        
        // Cole a URL do seu script publicado aqui
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwXNkae6flztT8pOeWue43YAE36pAPvyQrogTTBgPJectVVJdaN3yAe6JajgQu1c4Y/exec';

        submitButton.addEventListener('click', (event) => {
            event.preventDefault();
            
            const fullName = document.getElementById('fullName').value.trim();
            const cpf = document.getElementById('cpf').value.trim();
            const unidade = document.getElementById('unidade').value.trim();
            const birthDate = document.getElementById('birthDate').value.trim();

            if (!fullName || !cpf || !unidade || !birthDate) {
                alert('Por favor, preencha todos os campos do formulário.');
                return;
            }

            if (signaturePad.isEmpty()) {
                alert('Por favor, forneça sua assinatura.');
                return;
            }

            // Desabilita o botão e mostra uma mensagem de envio
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            // Pega a assinatura como uma imagem no formato Base64
            const signatureDataURL = signaturePad.toDataURL('image/png');
            
            // Cria o objeto com os dados para enviar
            const formData = {
                fullName: fullName,
                cpf: cpf,
                unidade: unidade,
                birthDate: birthDate,
                signature: signatureDataURL
            };

            // Envia os dados para o Google Apps Script usando a API fetch
            fetch(scriptURL, {
                method: 'POST',
                body: JSON.stringify(formData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Preenche o resumo com os dados
                    document.getElementById('summary-fullName').textContent = fullName;
                    document.getElementById('summary-cpf').textContent = cpf;
                    document.getElementById('summary-unidade').textContent = unidade;
                    document.getElementById('summary-birthDate').textContent = birthDate;
                    document.getElementById('summary-signature').src = signatureDataURL;

                    // Esconde o formulário e mostra a tela de sucesso
                    document.getElementById('form-container').style.display = 'none';
                    document.getElementById('summary-container').style.display = 'block';
                } else {
                    // Se der erro, mostra o erro e reativa o botão
                    alert('Ocorreu um erro ao enviar sua assinatura: ' + data.message);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Assinar e Enviar';
                }
            })
            .catch(error => {
                // Se der um erro de rede, mostra o erro e reativa o botão
                console.error('Erro:', error);
                alert('Ocorreu um erro de conexão. Tente novamente.');
                submitButton.disabled = false;
                submitButton.textContent = 'Assinar e Enviar';
            });
        });

        // ****** MÁSCARAS DOS CAMPOS (SEM MUDANÇAS) ******
        const cpfInput = document.getElementById('cpf');
        cpfInput.addEventListener('input', () => {
            let value = cpfInput.value.replace(/\D/g, '');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            cpfInput.value = value.slice(0, 14);
        });
        
        const birthDateInput = document.getElementById('birthDate');
        birthDateInput.addEventListener('input', () => {
            let value = birthDateInput.value.replace(/\D/g, '');
            value = value.replace(/(\d{2})(\d)/, '$1/$2');
            value = value.replace(/(\d{2})(\d)/, '$1/$2');
            birthDateInput.value = value.slice(0, 10);
        });
    });
</script>

</body>
</html>
