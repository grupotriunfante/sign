<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assinatura de Documento - Política de Compliance</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px 0; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; }
        h2 { text-align: center; color: #333; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .signature-pad-container { border: 1px solid #ddd; border-radius: 4px; position: relative; height: 200px; }
        canvas { width: 100%; height: 100%; display: block; }
        .buttons-container { display: flex; justify-content: space-between; margin-top: 20px; }
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #clear-signature { background-color: #6c757d; }
        #clear-signature:hover { background-color: #5a6268; }
        .summary { display: none; margin-top: 30px; }
        .summary h3 { text-align: center; }
        .summary p { font-size: 16px; margin: 10px 0; }
        .summary img { display: block; margin: 20px auto; border: 1px solid #ddd; border-radius: 4px; }

        /* Estilos para o container do PDF */
        .pdf-container {
            width: 100%;
            height: 500px; /* Altura da janela do PDF */
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 15px; /* Reduzi a margem para acomodar o novo texto */
        }
        .pdf-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        #confirmation-section {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-bottom: 20px;
            cursor: pointer;
        }
        #confirmation-section:hover { background-color: #dde3e8; }
        #confirmation-section input { margin-right: 10px; }
        #confirmation-section label { margin: 0; cursor: pointer; }

        fieldset:disabled { opacity: 0.5; pointer-events: none; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
</head>
<body>

<div class="container">
    <div id="main-content">
        <h2>Assinatura da Política de Compliance</h2>
        <p style="text-align: center;">Por favor, leia o documento abaixo e marque a caixa de confirmação para liberar o formulário de assinatura.</p>
        
        <div class="pdf-container">
            <iframe src="https://drive.google.com/file/d/1NkxsEROOFO9kS_5l0d2pUdB6rpXy4KC9/preview" title="Política de Compliance"></iframe>
        </div>

        <p style="text-align: center; font-size: 14px; color: #555; margin-bottom: 20px;">
            Para consultar esta política a qualquer momento, acesse o I-DOC: 
            <a href="https://drivetriunfante.com.br/index.php?r=cfiles%2Fbrowse%2Findex&fid=447&cguid=68d7854e-1d10-4146-97cb-ae0abfc79350#" target="_blank" rel="noopener noreferrer">Clique aqui</a>.
        </p>
        <div id="confirmation-section">
            <input type="checkbox" id="confirmation-checkbox">
            <label for="confirmation-checkbox">Declaro que li e concordo com a Política de Compliance.</label>
        </div>

        <fieldset id="signature-fieldset">
            <div class="form-group">
                <label for="fullName">Nome Completo:</label>
                <input type="text" id="fullName" name="fullName" required>
            </div>
            <div class="form-group">
                <label for="cpf">CPF:</label>
                <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" required>
            </div>
            <div class="form-group">
                <label for="unidade">Unidade:</label>
                <select id="unidade" name="unidade" required>
                    <option value="">Selecione a Unidade</option>
                    <option value="TPA">TPA</option><option value="TBA">TBA</option><option value="TCV">TCV</option><option value="ABC">ABC</option><option value="API">API</option><option value="TBL">TBL</option><option value="TSJ">TSJ</option><option value="TPH">TPH</option><option value="MCD">MCD</option><option value="TCG">TCG</option>
                </select>
            </div>
            <div class="form-group">
                <label for="birthDate">Data de Nascimento:</label>
                <input type="text" id="birthDate" name="birthDate" placeholder="DD/MM/AAAA" required>
            </div>
            <div class="form-group">
                <label for="signature">Campo para assinatura (livre):</label>
                <div class="signature-pad-container">
                    <canvas id="signature-pad"></canvas>
                </div>
            </div>
            <div class="buttons-container">
                <button id="clear-signature">Limpar Assinatura</button>
                <button id="submit-signature">Assinar e Enviar</button>
            </div>
        </fieldset>
    </div>
    
    <div id="summary-container" class="summary">
        <h3>✅ Assinatura Enviada com Sucesso!</h3>
        <p><strong>Nome Completo:</strong> <span id="summary-fullName"></span></p>
        <p><strong>CPF:</strong> <span id="summary-cpf"></span></p>
        <p><strong>Unidade:</strong> <span id="summary-unidade"></span></p>
        <p><strong>Data de Nascimento:</strong> <span id="summary-birthDate"></span></p>
        <p><strong>Assinatura Registrada:</strong></p>
        <img id="summary-signature" src="" alt="Assinatura Digital">
        <p style="text-align: center; margin-top: 20px;"><em>Seu registro foi salvo. Você já pode fechar esta janela.</em></p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas);

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        const clearButton = document.getElementById('clear-signature');
        clearButton.addEventListener('click', (event) => {
            event.preventDefault();
            signaturePad.clear();
        });

        // --- NOVA LÓGICA DE HABILITAÇÃO DO FORMULÁRIO ---
        const confirmationCheckbox = document.getElementById('confirmation-checkbox');
        const signatureFieldset = document.getElementById('signature-fieldset');

        // Desabilita o formulário e o signature pad inicialmente
        signatureFieldset.disabled = true;
        signaturePad.off();

        // Adiciona um evento que dispara quando a caixa de seleção é alterada
        confirmationCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // Se estiver marcada, habilita o formulário e a assinatura
                signatureFieldset.disabled = false;
                signaturePad.on();
            } else {
                // Se for desmarcada, desabilita tudo novamente
                signatureFieldset.disabled = true;
                signaturePad.off();
            }
        });
        // --- FIM DA NOVA LÓGICA ---


        // ****** SEU CÓDIGO DE ENVIO CONTINUA O MESMO ******
        const submitButton = document.getElementById('submit-signature');
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwXNkae6flztT8pOeWue43YAE36pAPvyQrogTTBgPJectVVJdaN3yAe6JajgQu1c4Y/exec';

        submitButton.addEventListener('click', (event) => {
            event.preventDefault();
            
            const fullName = document.getElementById('fullName').value.trim();
            const cpf = document.getElementById('cpf').value.trim();
            const unidade = document.getElementById('unidade').value.trim();
            const birthDate = document.getElementById('birthDate').value.trim();

            if (!fullName || !cpf || !unidade || !birthDate) {
                alert('Por favor, preencha todos os campos do formulário.');
                return;
            }

            if (signaturePad.isEmpty()) {
                alert('Por favor, forneça sua assinatura.');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            const signatureDataURL = signaturePad.toDataURL('image/png');
            
            const formData = {
                fullName: fullName,
                cpf: cpf,
                unidade: unidade,
                birthDate: birthDate,
                signature: signatureDataURL
            };

            fetch(scriptURL, {
                method: 'POST',
                body: JSON.stringify(formData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('summary-fullName').textContent = fullName;
                    document.getElementById('summary-cpf').textContent = cpf;
                    document.getElementById('summary-unidade').textContent = unidade;
                    document.getElementById('summary-birthDate').textContent = birthDate;
                    document.getElementById('summary-signature').src = signatureDataURL;

                    document.getElementById('main-content').style.display = 'none';
                    document.getElementById('summary-container').style.display = 'block';
                } else {
                    alert('Ocorreu um erro ao enviar sua assinatura: ' + data.message);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Assinar e Enviar';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Ocorreu um erro de conexão. Tente novamente.');
                submitButton.disabled = false;
                submitButton.textContent = 'Assinar e Enviar';
            });
        });

        // ****** MÁSCARAS DOS CAMPOS (SEM MUDANÇAS) ******
        const cpfInput = document.getElementById('cpf');
        cpfInput.addEventListener('input', () => {
            let value = cpfInput.value.replace(/\D/g, '');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            cpfInput.value = value.slice(0, 14);
        });
        
        const birthDateInput = document.getElementById('birthDate');
        birthDateInput.addEventListener('input', () => {
            let value = birthDateInput.value.replace(/\D/g, '');
            value = value.replace(/(\d{2})(\d)/, '$1/$2');
            value = value.replace(/(\d{2})(\d)/, '$1/$2');
            birthDateInput.value = value.slice(0, 10);
        });
    });
</script>

</body>
</html>
